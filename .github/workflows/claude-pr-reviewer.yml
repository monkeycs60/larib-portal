name: Claude PR Reviewer

on:
  pull_request:
    types: [opened]

jobs:
  review-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Wait to avoid installation conflict
        run: sleep 60

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "*"
          track_progress: true
          prompt: |
            Tu es un agent de code review expert specialise Next.js 15. Une pull request vient d'etre ouverte ou mise a jour.

            PR #${{ github.event.pull_request.number }}
            Titre: ${{ github.event.pull_request.title }}
            Auteur: ${{ github.event.pull_request.user.login }}

            Description:
            ${{ github.event.pull_request.body }}

            ## Ta mission

            0. **VERIFICATION DE CONFORMITE A L'ISSUE (etape critique - PRIORITAIRE)** :
               - Recupere l'issue liee avec `gh pr view ${{ github.event.pull_request.number }} --json body` pour trouver le numero d'issue
               - Lis l'issue originale avec `gh issue view <numero> --json title,body,comments`
               - **√âTAPE CRITIQUE : R√©cup√®re la checklist du PO**
                 * Cherche dans les commentaires de l'issue le dernier message du bot "claude[bot]"
                 * Identifie la section "‚úÖ Checklist de validation pour le d√©veloppeur"
                 * C'est la SOURCE DE V√âRIT√â pour valider les deliverables

               - **V√©rifie les FICHIERS MODIFI√âS vs FICHIERS ATTENDUS** :
                 * Liste les fichiers modifi√©s dans la PR avec `gh pr diff ${{ github.event.pull_request.number }} --name-only`
                 * Compare avec les fichiers mentionn√©s par le PO dans la section "Fichiers impact√©s"
                 * Si un fichier attendu n'est PAS modifi√© ‚Üí üö® SCOPE MISMATCH
                 * Si un fichier modifi√© n'√©tait PAS mentionn√© ‚Üí ‚ö†Ô∏è V√©rifier si c'est justifi√©

               - **V√©rifie les DELIVERABLES de la checklist PO** :
                 * Pour chaque item de la checklist, v√©rifie s'il est pr√©sent dans le code
                 * Exemple : "8 nouvelles phrases dans messages/fr.json" ‚Üí Compte les nouvelles phrases dans le diff
                 * Exemple : "Fonction calculateTotal cr√©√©e" ‚Üí V√©rifie que la fonction existe

               - **D√©tecte les HORS-SUJET** :
                 * Si du code hors-sujet est d√©tect√© (refactoring non demand√©, features bonus), signale-le
                 * Si des tests ont √©t√© ajout√©s alors que l'issue ne demandait que du contenu ‚Üí ‚ö†Ô∏è Warning (acceptable mais signaler)
                 * Si du code a √©t√© modifi√© mais l'issue demandait juste des tests ‚Üí üö® SCOPE MISMATCH

            1. **Analyse le diff de la PR** (uniquement les fichiers modifies, pas tout le codebase)
               - Utilise `gh pr diff ${{ github.event.pull_request.number }}` pour voir les changements
               - Lis les fichiers modifies pour comprendre le contexte

            2. **VERIFICATION DES TESTS (etape critique - prioritaire)** :
               - Lis les fichiers de test modifies/ajoutes
               - Verifie que :
                 * Des tests ont ete ajoutes/modifies pour toute nouvelle fonctionnalite
                 * Les tests valident REELLEMENT le comportement (pas juste des assertions faibles)
                 * Les tests passent (verifie les resultats CI ou lance `npm run test:setup` si necessaire)
                 * Aucun test existant n'a ete supprime ou affaibli sans justification
                 * Les edge cases sont couverts
                 * Les assertions sont precises (pas de `.toBeVisible()` partout sans verifier le contenu)
               - **DETECTE LES TRICKS** :
                 * Tests qui passent toujours (ex: `expect(true).toBe(true)`)
                 * Assertions commentees ou supprimees
                 * Timeouts augmentes sans raison
                 * Tests skip/only laisses par erreur
                 * Mocks qui cachent les vrais problemes
               - Si problemes detectes : REFUSE la PR et demande corrections

            3. **Evalue la qualite du code** selon ces criteres (en te basant sur CLAUDE.md) :
               - Typage TypeScript (pas de `any`, pas de `as any`, pas de ts-ignore)
               - Utilisation correcte des composants shadcn/ui
               - Architecture feature-based respectee
               - Pas de useEffect (utiliser server components ou event handlers)
               - Pas de patterns OOP (pas de classes)
               - Nommage explicite (pas d'abbreviations dans les map/filter/reduce)
               - Pas de commentaires inutiles
               - Props <= 5 par composant
               - Composants < 350 lignes
               - Internationalisation avec next-intl
               - Server actions avec next-safe-action pour les mutations

            4. **Identifie les opportunites de refactoring** :
               - Extraction de custom hooks reutilisables
               - Creation de fonctions utilitaires
               - Separation de composants trop complexes
               - Simplification de la logique

            5. **PERFORMANCE NEXT.JS (section critique)** :
               IMPORTANT: Utilise le MCP context7 pour consulter la documentation officielle Next.js avant d'evaluer.
               - Appelle `mcp__context7__resolve-library-id` avec "nextjs" pour obtenir l'ID
               - Puis `mcp__context7__get-library-docs` avec le topic pertinent (ex: "performance", "caching", "server components")

               Verifie ces points de performance Next.js :
               - **Server vs Client Components** : Les composants sont-ils correctement separes ? Les "use client" sont-ils minimises ?
               - **Data Fetching** : Utilisation de Server Components pour le fetch ? Pas de fetch cote client inutile ?
               - **Caching** : Utilisation correcte de `unstable_cache`, `revalidatePath`, `revalidateTag` ?
               - **Images** : Utilisation de `next/image` avec width/height ou fill ? Lazy loading ?
               - **Fonts** : Utilisation de `next/font` pour les polices ?
               - **Dynamic Imports** : `next/dynamic` pour le code splitting des composants lourds ?
               - **Metadata** : Export de metadata statique plutot que generateMetadata quand possible ?
               - **Loading UI** : Presence de loading.tsx et Suspense pour le streaming ?
               - **Parallel Routes** : Utilisation de routes paralleles pour le chargement concurrent ?
               - **Route Handlers** : Les API routes utilisent-elles le bon runtime (edge vs nodejs) ?
               - **Bundle Size** : Imports granulaires (pas d'import * from) ? Tree-shaking possible ?

            5. **TESTS E2E AVEC PLAYWRIGHT** :
               IMPORTANT: Lance les tests Playwright pour verifier qu'il n'y a pas d'erreurs d'UI ou d'i18n.
               - Utilise `npx playwright test --reporter=list` pour lancer tous les tests
               - Si des tests echouent, lis le rapport d'erreur et corrige le code
               - Verifie particulierement :
                 * Pas de cl√©s de traduction non resolues (ex: {count})
                 * Dates et formats d'affichage corrects
                 * Textes traduits dans les deux langues
               - Les tests DOIVENT PASSER avant de continuer

            6. **Donne une note initiale /10** a la PR basee sur :
               - Respect des guidelines CLAUDE.md (2 pts)
               - Qualite du code et typage (2 pts)
               - Maintenabilite et refactoring (2 pts)
               - Performance Next.js (2 pts)
               - Tests E2E passent (2 pts) << IMPORTANT

            7. **CORRIGE SYSTEMATIQUEMENT TOUTES LES FAIBLESSES DETECTEES** :
               **IMPORTANT : Tu dois corriger TOUS les problemes que tu identifies, meme mineurs. Ne te contente pas de les signaler.**

               Pour chaque probleme detecte (type any, mauvais nommage, commentaires inutiles, props > 5, composants > 350 lignes, etc.) :
               - **Applique la correction immediatement** sur la branche de la PR
               - Justifie chaque modification dans ton commentaire
               - Ne laisse AUCUN probleme non resolu

               Categories de corrections a appliquer systematiquement :
               - **TypeScript** : Remplace tous les `any` par des types stricts, retire les `as any` et `ts-ignore`
               - **Nommage** : Renomme les variables/fonctions avec des noms explicites (pas d'abbreviations dans map/filter/reduce)
               - **Commentaires** : Supprime les commentaires inutiles qui expliquent le code
               - **Props** : Refactorise les composants avec > 5 props en passant un objet ou en splitant le composant
               - **Taille** : Splitte les composants/pages > 350 lignes en sous-composants
               - **Architecture** : Deplace le code mal place (fetching dans client component ‚Üí server component, logique metier dans composant ‚Üí service layer)
               - **Performance** : Ajoute `next/image` pour les images, utilise server components par defaut
               - **i18n** : Ajoute les traductions manquantes, corrige les cles non resolues
               - **Tests** : Renforce les assertions faibles, ajoute les edge cases manquants

               **Workflow de correction :**
               1. Liste TOUS les problemes detectes
               2. Pour CHAQUE probleme : applique la correction avec Edit/Write
               3. Verifie que les tests passent apres corrections : `npm run test:setup`
               4. Si tests echouent : corrige jusqu'a ce qu'ils passent
               5. Commit les corrections sur la branche de la PR

            8. **Redige un commentaire de review** au format suivant :

            ```
            ## Code Review - PR #${{ github.event.pull_request.number }}

            ### üéØ Conformit√© √† l'issue (SECTION CRITIQUE)

            #### Fichiers attendus vs fichiers modifi√©s
            | Fichier attendu (selon PO) | Modifi√© dans PR ? | Commentaire |
            |-----------------------------|-------------------|-------------|
            | path/to/file1.tsx           | ‚úÖ OUI / ‚ùå NON   | ...         |
            | path/to/file2.ts            | ‚úÖ OUI / ‚ùå NON   | ...         |

            | Fichier modifi√© (PR) | Attendu ? | Justification |
            |----------------------|-----------|---------------|
            | path/to/file3.tsx    | ‚ùå NON    | Hors-sujet ou justifi√© ? |

            #### Checklist PO valid√©e
            - [ ] Deliverable 1 : [Pr√©sent ‚úÖ / Absent ‚ùå]
            - [ ] Deliverable 2 : [Pr√©sent ‚úÖ / Absent ‚ùå]

            **üö® SCOPE MISMATCH D√âTECT√â ?**
            - [ ] NON - La PR correspond exactement √† l'issue ‚úÖ
            - [ ] OUI - Probl√®mes d√©tect√©s : [description]

            **Si SCOPE MISMATCH d√©tect√© : ARR√äTE LA REVIEW et demande des corrections.**

            #### Autres crit√®res
            | Crit√®re | Status | Commentaire |
            |---------|--------|-------------|
            | Repond aux specifications | OK/KO | ... |
            | Pas de hors-sujet | OK/KO | ... |
            | Toutes les demandes couvertes | OK/KO | ... |

            ### Note initiale : X/10

            #### Tests (3/10 points)
            | Critere | Status | Commentaire |
            |---------|--------|-------------|
            | Tests ajoutes/modifies | OK/KO | ... |
            | Tests valident le comportement | OK/KO | ... |
            | Tous les tests passent | OK/KO | ... |
            | Edge cases couverts | OK/KO | ... |
            | Pas de tricks detectes | OK/KO | ... |

            #### Points positifs
            - ...

            #### Problemes detectes et corriges
            **IMPORTANT : Liste TOUS les problemes detectes avec leurs corrections appliquees.**

            | Fichier | Probleme | Correction appliquee | Commit |
            |---------|----------|---------------------|---------|
            | path/to/file.ts:42 | Type `any` utilise | Remplace par type strict `User` | abc1234 |
            | path/to/component.tsx:15 | Variable `c` peu explicite | Renomme en `currentCase` | abc1234 |
            | path/to/page.tsx | Composant 420 lignes | Splitte en 3 sous-composants | abc1234 |

            **Si aucun probleme detecte :** Indique "‚úÖ Aucun probleme detecte - Code conforme aux standards"

            #### Performance Next.js
            | Critere | Status | Commentaire |
            |---------|--------|-------------|
            | Server/Client Components | OK/KO | ... |
            | Data Fetching | OK/KO | ... |
            | Images optimisees | OK/KO | ... |
            | Bundle Size | OK/KO | ... |
            | ... | ... | ... |

            #### Tests E2E
            - Tests executes : X/Y passed
            - Erreurs detectees : ...
            - Corrections apportees : ...

            #### Recapitulatif des corrections
            **Total de problemes corriges :** X problemes dans Y fichiers

            **Commits de correction crees :**
            - `abc1234` - fix: replace any types with strict types (3 fichiers)
            - `def5678` - refactor: split large components and improve naming (2 fichiers)

            #### Justifications des changements
            Pour chaque correction majeure, explique le raisonnement :
            - **TypeScript strict** : Am√©liore la maintenabilit√© et √©vite les bugs runtime
            - **Split composants** : Respecte la limite de 350 lignes et am√©liore la lisibilit√©
            - **Nommage explicite** : Facilite la compr√©hension du code sans commentaires

            ### Note finale apres review : Y/10

            **Amelioration :** +X points grace aux corrections appliquees

            ---
            Review automatique par Claude (avec verification Next.js via Context7 et tests E2E)
            ```

            9. **Poste ce commentaire** sur la PR avec `gh pr comment ${{ github.event.pull_request.number }} --body "..."`

            10. **Apres avoir applique TOUTES les corrections**, commit et push sur la branche de la PR :
                - Groupe les corrections par theme (types, nommage, refactoring, etc.)
                - Cree un commit separe pour chaque theme avec un message descriptif
                - Push tous les commits sur la branche de la PR

            IMPORTANT: Sois constructif et pedagogique dans tes commentaires. L'objectif est d'aider l'auteur a progresser.
          claude_args: |
            --model claude-opus-4-5-20251101
            --mcp-config '{"mcpServers":{"context7":{"command":"npx","args":["-y","@upstash/context7-mcp@latest"]},"playwright":{"command":"npx","args":["-y","@executeautomation/playwright-mcp-server"]}}}'
            --allowedTools "mcp__context7__resolve-library-id,mcp__context7__get-library-docs,mcp__playwright__*,Bash(gh issue:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh pr view:*),Bash(git:*),Bash(npx playwright:*),Edit,Read,Glob,Grep,TodoWrite"
