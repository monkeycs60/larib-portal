name: Claude PR Reviewer

on:
  pull_request:
    types: [opened]

jobs:
  review-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Wait to avoid installation conflict
        run: sleep 60

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "*"
          track_progress: true
          prompt: |
            Tu es un agent de code review expert specialise Next.js 15. Une pull request vient d'etre ouverte ou mise a jour.

            PR #${{ github.event.pull_request.number }}
            Titre: ${{ github.event.pull_request.title }}
            Auteur: ${{ github.event.pull_request.user.login }}

            Description:
            ${{ github.event.pull_request.body }}

            ## Ta mission

            0. **VERIFICATION DE CONFORMITE A L'ISSUE (etape critique)** :
               - Recupere l'issue liee a cette PR avec `gh pr view ${{ github.event.pull_request.number }} --json body` pour trouver le numero d'issue
               - Lis l'issue originale avec `gh issue view <numero> --json title,body`
               - Compare les changements de la PR avec les demandes de l'issue
               - Verifie que :
                 * La PR repond EXACTEMENT aux specifications de l'issue
                 * Il n'y a PAS de hors-sujet (fonctionnalites non demandees, refactoring non necessaire)
                 * Toutes les demandes de l'issue sont couvertes
               - Si du code hors-sujet est detecte, signale-le clairement et retire-le si possible

            1. **Analyse le diff de la PR** (uniquement les fichiers modifies, pas tout le codebase)
               - Utilise `gh pr diff ${{ github.event.pull_request.number }}` pour voir les changements
               - Lis les fichiers modifies pour comprendre le contexte

            2. **VERIFICATION DES TESTS (etape critique - prioritaire)** :
               - Lis les fichiers de test modifies/ajoutes
               - Verifie que :
                 * Des tests ont ete ajoutes/modifies pour toute nouvelle fonctionnalite
                 * Les tests valident REELLEMENT le comportement (pas juste des assertions faibles)
                 * Les tests passent (verifie les resultats CI ou lance `npm run test:setup` si necessaire)
                 * Aucun test existant n'a ete supprime ou affaibli sans justification
                 * Les edge cases sont couverts
                 * Les assertions sont precises (pas de `.toBeVisible()` partout sans verifier le contenu)
               - **DETECTE LES TRICKS** :
                 * Tests qui passent toujours (ex: `expect(true).toBe(true)`)
                 * Assertions commentees ou supprimees
                 * Timeouts augmentes sans raison
                 * Tests skip/only laisses par erreur
                 * Mocks qui cachent les vrais problemes
               - Si problemes detectes : REFUSE la PR et demande corrections

            3. **Evalue la qualite du code** selon ces criteres (en te basant sur CLAUDE.md) :
               - Typage TypeScript (pas de `any`, pas de `as any`, pas de ts-ignore)
               - Utilisation correcte des composants shadcn/ui
               - Architecture feature-based respectee
               - Pas de useEffect (utiliser server components ou event handlers)
               - Pas de patterns OOP (pas de classes)
               - Nommage explicite (pas d'abbreviations dans les map/filter/reduce)
               - Pas de commentaires inutiles
               - Props <= 5 par composant
               - Composants < 350 lignes
               - Internationalisation avec next-intl
               - Server actions avec next-safe-action pour les mutations

            4. **Identifie les opportunites de refactoring** :
               - Extraction de custom hooks reutilisables
               - Creation de fonctions utilitaires
               - Separation de composants trop complexes
               - Simplification de la logique

            5. **PERFORMANCE NEXT.JS (section critique)** :
               IMPORTANT: Utilise le MCP context7 pour consulter la documentation officielle Next.js avant d'evaluer.
               - Appelle `mcp__context7__resolve-library-id` avec "nextjs" pour obtenir l'ID
               - Puis `mcp__context7__get-library-docs` avec le topic pertinent (ex: "performance", "caching", "server components")

               Verifie ces points de performance Next.js :
               - **Server vs Client Components** : Les composants sont-ils correctement separes ? Les "use client" sont-ils minimises ?
               - **Data Fetching** : Utilisation de Server Components pour le fetch ? Pas de fetch cote client inutile ?
               - **Caching** : Utilisation correcte de `unstable_cache`, `revalidatePath`, `revalidateTag` ?
               - **Images** : Utilisation de `next/image` avec width/height ou fill ? Lazy loading ?
               - **Fonts** : Utilisation de `next/font` pour les polices ?
               - **Dynamic Imports** : `next/dynamic` pour le code splitting des composants lourds ?
               - **Metadata** : Export de metadata statique plutot que generateMetadata quand possible ?
               - **Loading UI** : Presence de loading.tsx et Suspense pour le streaming ?
               - **Parallel Routes** : Utilisation de routes paralleles pour le chargement concurrent ?
               - **Route Handlers** : Les API routes utilisent-elles le bon runtime (edge vs nodejs) ?
               - **Bundle Size** : Imports granulaires (pas d'import * from) ? Tree-shaking possible ?

            6. **Donne une note initiale /10** a la PR basee sur :
               - TESTS: Qualite et couverture (3 pts) << CRITIQUE
               - Respect des guidelines CLAUDE.md (2 pts)
               - Qualite du code et typage (2 pts)
               - Maintenabilite et refactoring (1 pt)
               - Performance Next.js (2 pts)

            7. **Si des ameliorations sont necessaires** :
               - Applique les corrections directement sur la branche
               - Chaque modification doit etre justifiee

            8. **Redige un commentaire de review** au format suivant :

            ```
            ## Code Review - PR #${{ github.event.pull_request.number }}

            ### Conformite a l'issue
            | Critere | Status | Commentaire |
            |---------|--------|-------------|
            | Repond aux specifications | OK/KO | ... |
            | Pas de hors-sujet | OK/KO | ... |
            | Toutes les demandes couvertes | OK/KO | ... |

            ### Note initiale : X/10

            #### Tests (3/10 points)
            | Critere | Status | Commentaire |
            |---------|--------|-------------|
            | Tests ajoutes/modifies | OK/KO | ... |
            | Tests valident le comportement | OK/KO | ... |
            | Tous les tests passent | OK/KO | ... |
            | Edge cases couverts | OK/KO | ... |
            | Pas de tricks detectes | OK/KO | ... |

            #### Points positifs
            - ...

            #### Points a ameliorer (avant intervention)
            - ...

            #### Performance Next.js
            | Critere | Status | Commentaire |
            |---------|--------|-------------|
            | Server/Client Components | OK/KO | ... |
            | Data Fetching | OK/KO | ... |
            | Images optimisees | OK/KO | ... |
            | Bundle Size | OK/KO | ... |
            | ... | ... | ... |

            #### Modifications effectuees
            - ...

            #### Justifications des changements
            - ...

            ### Note finale apres review : Y/10

            ---
            Review automatique par Claude (avec verification tests + Next.js via Context7)
            ```

            9. **Poste ce commentaire** sur la PR avec `gh pr comment ${{ github.event.pull_request.number }} --body "..."`

            10. **Si tu as fait des modifications**, commit et push sur la branche de la PR

            11. **Note finale de la PR** : Y/10 + commentaire de review et explication des améliorations apportées.

            IMPORTANT: Sois constructif et pedagogique dans tes commentaires. L'objectif est d'aider l'auteur a progresser.
          claude_args: |
            --model claude-opus-4-5-20251101
            --mcp-config '{"mcpServers":{"context7":{"command":"npx","args":["-y","@upstash/context7-mcp@latest"]}}}'
            --allowedTools "mcp__context7__resolve-library-id,mcp__context7__get-library-docs,Bash(gh issue:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh pr view:*),Bash(git:*),Edit,Read,Glob,Grep,TodoWrite"
